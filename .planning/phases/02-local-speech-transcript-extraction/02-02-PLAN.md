---
phase: 02-local-speech-transcript-extraction
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - 02-worktrees/asr-runner/pyproject.toml
  - 02-worktrees/asr-runner/asr_pipeline.py
  - 02-worktrees/asr-runner/schemas/transcript.py
  - 02-worktrees/asr-runner/utils/confidence.py
  - 02-worktrees/asr-runner/utils/export.py
autonomous: true
requirements:
  - ASR-02
  - ASR-03
user_setup:
  - service: huggingface
    why: "Download pyannote diarization model weights locally if not cached"
    env_vars:
      - name: HF_TOKEN
        source: "Hugging Face account token (accept pyannote license)"
must_haves:
  truths:
    - "User can run local ASR to produce word-timestamped transcripts without paid APIs."
    - "Transcript exports default to normalized JSONL segments with confidence metadata and flags."
  artifacts:
    - path: "02-worktrees/asr-runner/asr_pipeline.py"
      provides: "CLI to run VAD + ASR + whisperX alignment + export"
      exports: ["--source-id", "--input-audio", "--out-dir", "--min-confidence"]
    - path: "02-worktrees/asr-runner/schemas/transcript.py"
      provides: "Data models for raw/normalized segments with per-word confidence and flags"
    - path: "02-worktrees/asr-runner/utils/confidence.py"
      provides: "Aggregators computing segment confidence and quality flags"
    - path: "02-worktrees/asr-runner/utils/export.py"
      provides: "JSONL writer ensuring raw+normalized records stored under transcripts/{source_id}"
  key_links:
    - from: "02-worktrees/asr-runner/asr_pipeline.py"
      to: "02-worktrees/asr-runner/audio_prep.py"
      via: "consumes demuxed/isolated wav and prep manifest"
      pattern: "audio_prep_manifest"
    - from: "02-worktrees/asr-runner/asr_pipeline.py"
      to: "02-worktrees/asr-runner/schemas/transcript.py"
      via: "TranscriptSegment model"
      pattern: "TranscriptSegment"
    - from: "02-worktrees/asr-runner/utils/export.py"
      to: "00-supporting-files/data/transcripts/{source_id}/"
      via: "JSONL writer path join"
      pattern: "transcripts/.*/segments-.*\\.jsonl"
---

<objective>
Build a ROCm-ready ASR pipeline that consumes prepped DougDoug audio, runs faster-whisper + whisperX with diarization, aggregates confidences, and exports normalized JSONL segments with quality flags.

Purpose: Satisfy ASR-02/ASR-03 by delivering local, timestamped transcripts enriched with confidence metadata and downstream-friendly storage.
Output: ASR CLI, transcript schemas, confidence/export utilities, pinned ASR dependencies.
</objective>

<execution_context>
@/home/bedhedd/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bedhedd/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-local-speech-transcript-extraction/02-CONTEXT.md
@.planning/phases/02-local-speech-transcript-extraction/02-RESEARCH.md
@.planning/phases/02-local-speech-transcript-extraction/02-01-PLAN.md
@02-worktrees/asr-runner/audio_prep.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ASR dependencies for ROCm</name>
  <files>02-worktrees/asr-runner/pyproject.toml</files>
  <action>Pin ASR stack in `pyproject.toml`: faster-whisper 1.2.x, whisperx 3.8.x, ffmpeg-python, torch/torchaudio from ROCm 6.0 index, ctranslate2/ctranslate2-support if needed, pyannote.audio 3.2.x (diarization), msgspec or pydantic 2.x for schemas. Include optional demucs/uvr5 extra for isolation alignment reuse. Document ROCm index usage and provide `uv lock` guidance.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python -c "import faster_whisper, whisperx"</automated>
  </verify>
  <done>ASR dependencies installed with ROCm-friendly pins and importable within the worktree.</done>
</task>

<task type="auto">
  <name>Task 2: Define transcript schemas and confidence aggregation</name>
  <files>02-worktrees/asr-runner/schemas/transcript.py, 02-worktrees/asr-runner/utils/confidence.py, 02-worktrees/asr-runner/utils/export.py</files>
  <action>Create `schemas/transcript.py` models for RawSegment, NormalizedSegment, WordTiming capturing start/end, speaker label, raw text, normalized text, per-word logprob/confidence, VAD/overlap flags, quality flags, and source metadata (source_id, sample_rate, channel_map). Implement `utils/confidence.py` to aggregate per-segment confidence (mean/min of word confidences), flag low-confidence spans, and default filter threshold 0.70. Add `utils/export.py` to write paired raw/normalized JSONL under `00-supporting-files/data/transcripts/{source_id}/` with deterministic filenames and include manifest references.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python -c "from schemas.transcript import NormalizedSegment; print('schema_loaded', bool(NormalizedSegment))"</automated>
  </verify>
  <done>Schema and aggregation utilities exist and can serialize raw + normalized segment records with confidence metadata.</done>
</task>

<task type="auto">
  <name>Task 3: Implement ASR + alignment + export pipeline</name>
  <files>02-worktrees/asr-runner/asr_pipeline.py</files>
  <action>Build `asr_pipeline.py` CLI that consumes prep manifest + wav from 02-01, runs faster-whisper with word timestamps and VAD, applies whisperX alignment and optional pyannote diarization for speaker tags, segments into ~8â€“12s phrase windows retaining per-word timestamps, normalizes text to sentence case with inline non-speech tags, aggregates confidence/overlap flags, and writes raw + normalized JSONL via export utils. Default filter: export segments with confidence >=0.70 while flagging low-confidence spans instead of dropping. Include options for batch processing, GPU/compute_type selection, and dry-run.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python asr_pipeline.py --help</automated>
  </verify>
  <done>Running the CLI on a prepared source yields timestamped transcripts with speaker labels, confidences, and normalized JSONL stored under transcripts/{source_id}.</done>
</task>

</tasks>

<verification>
ASR CLI help available (`uv run --project 02-worktrees/asr-runner python asr_pipeline.py --help`). End-to-end run on a prepared source emits paired raw/normalized JSONL with confidences and flags.</verification>

<success_criteria>
- ASR pipeline runs locally without paid APIs and imports faster-whisper/whisperX on ROCm
- JSONL exports contain raw + normalized text, per-word timestamps, confidences/logprobs, speaker labels, and quality flags
- Default confidence filter (>=0.70) applied while retaining flagged low-confidence spans
</success_criteria>

<output>
After completion, create `.planning/phases/02-local-speech-transcript-extraction/02-02-SUMMARY.md`.
</output>
