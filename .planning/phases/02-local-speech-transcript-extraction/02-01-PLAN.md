---
phase: 02-local-speech-transcript-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 02-worktrees/asr-runner/pyproject.toml
  - 02-worktrees/asr-runner/audio_prep.py
  - 02-worktrees/asr-runner/utils/paths.py
  - 02-worktrees/asr-runner/utils/audio.py
  - 00-supporting-files/data/transcripts/README.md
autonomous: true
requirements:
  - ASR-01
user_setup: []
must_haves:
  truths:
    - "User can produce DougDoug-only mono 16 kHz wav files from ingested videos using a deterministic CLI."
    - "Audio prep logs capture channel map, sample rate, duration, and any isolation/quality flags per source."
  artifacts:
    - path: "02-worktrees/asr-runner/audio_prep.py"
      provides: "CLI for demux/resample and conditional vocal isolation"
    - path: "02-worktrees/asr-runner/utils/audio.py"
      provides: "Functions for demux, overlap probes, isolation triggers, manifest writing"
    - path: "00-supporting-files/data/transcripts/README.md"
      provides: "Documented storage layout for prepared audio/transcripts"
  key_links:
    - from: "02-worktrees/asr-runner/audio_prep.py"
      to: "00-supporting-files/data/transcripts/{source_id}/source-{source_id}-mono16k.wav"
      via: "paths.resolve_transcript_dir + deterministic filename"
      pattern: "source-.*-mono16k\\.wav"
    - from: "02-worktrees/asr-runner/audio_prep.py"
      to: "02-worktrees/asr-runner/utils/audio.py"
      via: "AudioPrepRunner uses demux_and_optionally_isolate helper"
      pattern: "demux_and_optionally_isolate"
---

<objective>
Establish an ROCm-friendly audio prep worktree that deterministically demuxes DougDoug streams to mono 16 kHz wav, conditionally runs vocal isolation when overlap/music is detected, and logs prep metadata for reuse.

Purpose: Provide clean, reproducible DougDoug-only audio inputs that satisfy ASR-01 and feed later ASR pipelines.
Output: asr-runner pyproject, path/audio helpers, audio_prep CLI, transcripts data layout README.
</objective>

<execution_context>
@/home/bedhedd/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bedhedd/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-local-speech-transcript-extraction/02-CONTEXT.md
@.planning/phases/02-local-speech-transcript-extraction/02-RESEARCH.md
@02-worktrees/chat-extraction/chat-extraction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold ASR audio prep worktree</name>
  <files>02-worktrees/asr-runner/pyproject.toml, 02-worktrees/asr-runner/utils/paths.py</files>
  <action>Create a new `asr-runner` worktree with uv-managed `pyproject.toml` targeting Python 3.13. Add dependencies for prep (ffmpeg-python, soundfile, librosa, rich/loguru, click/typer). Implement `utils/paths.py` with helpers mirroring chat-extraction path discovery (project_parent, supporting_files, transcripts_dir, temp_dir) to keep scripts relocatable. Ensure ROCm GPU visibility checks are logged but non-blocking.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python -c "import importlib; importlib.import_module('utils.paths')"</automated>
  </verify>
  <done>Worktree bootstrapped with importable path helpers and dependencies locked via uv.</done>
</task>

<task type="auto">
  <name>Task 2: Implement deterministic demux/resample CLI</name>
  <files>02-worktrees/asr-runner/audio_prep.py, 02-worktrees/asr-runner/utils/audio.py, 00-supporting-files/data/transcripts/README.md</files>
  <action>Create `audio_prep.py` CLI (click/typer) that accepts `--source-id` and input video/audio, demuxes with ffmpeg to mono 16 kHz wav, and writes outputs under `00-supporting-files/data/transcripts/{source_id}/source-{source_id}-mono16k.wav`. Use `utils/audio.py` to wrap demux/resample, duration validation via soundfile/librosa, and manifest writing capturing source path, duration, channel map, sample rate, checksum, and run timestamp. Make re-runs idempotent (skip or overwrite flag) and document layout/filenames in README.md.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python audio_prep.py --help</automated>
  </verify>
  <done>CLI produces mono16k wav and manifest per source_id in transcripts directory with deterministic naming and validation logs.</done>
</task>

<task type="auto">
  <name>Task 3: Add overlap detection and conditional vocal isolation</name>
  <files>02-worktrees/asr-runner/audio_prep.py, 02-worktrees/asr-runner/utils/audio.py</files>
  <action>Augment audio prep with short-window band-energy/RT60-style overlap probe plus Silero VAD flags to decide when music/overlap is present. When triggered, run light Demucs/UVR5 separation (ROCm torch) to produce `source-{source_id}-vocal.wav`; otherwise reuse demuxed mix. Record isolation decision, quality metrics (SNR estimate, overlap score), and any separation warnings in the manifest. Never drop low-quality outputsâ€”flag them for downstream filtering per locked policy.</action>
  <verify>
    <automated>uv run --project 02-worktrees/asr-runner python audio_prep.py --help</automated>
  </verify>
  <done>Prep pipeline conditionally emits vocal-isolated wavs with recorded quality flags and still retains raw mix artifacts.</done>
</task>

</tasks>

<verification>
Run audio prep help to confirm CLI is available: `uv run --project 02-worktrees/asr-runner python audio_prep.py --help`. For a sample input, confirm manifest logs duration/rate and isolation decision.</verification>

<success_criteria>
- audio_prep CLI generates mono16k wavs under transcripts/{source_id} with deterministic names
- manifests include channel map, duration, sample rate, checksum, and isolation/quality flags
- overlap detection triggers light isolation only when cues present; raw mix is retained
</success_criteria>

<output>
After completion, create `.planning/phases/02-local-speech-transcript-extraction/02-01-SUMMARY.md`.
</output>
